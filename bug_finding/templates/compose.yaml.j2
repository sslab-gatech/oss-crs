{# Macro to generate LITELLM_URL environment variable #}
{%- macro litellm_url_env() %}
{%- if external_litellm %}
      - LITELLM_URL=${LITELLM_URL}
{%- else %}
      - LITELLM_URL=http://crs-litellm-{{ config_hash }}-litellm-1:4000
{%- endif %}
{%- endmacro %}

{# Macro to generate CRS network configuration #}
{%- macro crs_network() %}
{%- if not external_litellm %}
    networks:
      - {{ config_hash }}_crs_network
{%- endif %}
{%- endmacro %}

{# Macro to generate volume name #}
{%- macro volume_name(volume_type, crs_name) -%}
{{ config_hash }}_{{ volume_type }}_{{ crs_name }}
{%- endmacro %}

services:
{%- for crs in crs_list %}

{%- if mode == 'build' %}
  # Key Provisioner {{ loop.index }} - {{ crs.name }}
  {{ crs.name }}_key_provisioner:
    profiles:
      - {{ crs.name }}_builder
    build:
      context: {{ key_provisioner_path }}
      dockerfile: Dockerfile
    environment:
{{ litellm_url_env() }}
{%- if external_litellm %}
      - LITELLM_KEY=${LITELLM_KEY}
      - EXTERNAL_LITELLM=true
{%- else %}
      - LITELLM_MASTER_KEY=${LITELLM_MASTER_KEY}
{%- endif %}
{{ crs_network() }}
    volumes:
      - {{ volume_name('keys_data', crs.name) }}:/keys/{{ crs.name }}
      - {{ config_dir }}:/config:ro
    command: ["python", "key_provisioner.py", "--config-dir", "/config", "--crs", "{{ crs.name }}"]
    healthcheck:
      test: ["CMD", "test", "-f", "/keys/{{ crs.name }}/api_key"]
      interval: 2s
      timeout: 1s
      retries: 30
    # restart: on-failure:5

  # CRS Builder {{ loop.index }} - {{ crs.name }}
  {{ crs.name }}_builder:
    profiles:
      - {{ crs.name }}_builder
    image: {{ project }}_{{ crs.name }}_builder{% if source_tag %}:{{ source_tag }}{% endif %}
{%- if crs.dind and not crs.host_docker_builder %}
    privileged: true
{%- endif %}
    shm_size: 2g
    depends_on:
      {{ crs.name }}_key_provisioner:
        condition: service_healthy
    environment:
{{ litellm_url_env() }}
{%- if crs.dind %}
      - PARENT_IMAGE={{ parent_image_prefix }}/{{ project }}
{%- endif %}
      - FUZZING_ENGINE={{ engine }}
      - SANITIZER={{ sanitizer }}
      - ARCHITECTURE={{ architecture }}
      - PROJECT_NAME={{ project }}
      - FUZZING_LANGUAGE={{ project_language }}
      - HELPER=True
{%- if crs.host_docker_builder %}
      - HOST_WORK_DIR={{ build_dir }}/work/{{ crs.name }}/{{ project }}
      - HOST_OUT_DIR={{ build_dir }}/out/{{ crs.name }}/{{ project }}
      - HOST_CRS_DIR={{ crs.path }}
{%- endif %}
{{ crs_network() }}
    build:
      context: {{ crs.path }}
      dockerfile: builder.Dockerfile
      additional_contexts:
        project: {{ oss_fuzz_path }}/projects/{{ project }}
      args:
        - CRS_TARGET={{ project }}
        - PROJECT_PATH={{ oss_fuzz_path }}/projects/{{ project }}
        - parent_image={{ parent_image_prefix }}/{{ project }}
    volumes:
      - {{ build_dir }}/out/{{ crs.name }}/{{ project }}:/out
      - {{ build_dir }}/work/{{ crs.name }}/{{ project }}:/work
      - {{ volume_name('keys_data', crs.name) }}:/keys:ro
{%- if crs.dind %}
      - {{ build_dir }}/crs/parent-images/{{ project }}.tar:/project-image.tar:ro
{%- endif %}
{%- if crs.host_docker_builder %}
      - /var/run/docker.sock:/var/run/docker.sock
{%- endif %}
{%- for vol in crs.volumes %}
      - {{ vol }}
{%- endfor %}
{%- if source_path %}
      - {{ source_path }}:/local-source-mount
{%- endif %}
{%- endif %}

{%- if mode == 'run' %}
  # CRS Runner {{ loop.index }} - {{ crs.name }}
  {{ crs.name }}_runner:
    image: {{ crs.name }}_runner
{%- if not crs.host_docker_builder %}
    privileged: true
{%- endif %}
    shm_size: 2g
    environment:
{{ litellm_url_env() }}
      - FUZZING_ENGINE={{ engine }}
      - SANITIZER={{ sanitizer }}
      - RUN_FUZZER_MODE=interactive
      - HELPER=True
      - CPUSET_CPUS={{ crs.cpuset }}
      - MEMORY_LIMIT={{ crs.memory_limit | string }}
      - CRS_TARGET={{ project }}
      - CRS_NAME={{ crs.name }}
{%- if crs.host_docker_builder %}
      - HOST_OUT_DIR={{ build_dir }}/out/{{ crs.name }}/{{ project }}
{%- endif %}
{{ crs_network() }}
    build:
      context: {{ crs.path }}
      dockerfile: runner.Dockerfile
      args:
        - PROJECT_PATH={{ oss_fuzz_path }}/projects/{{ project }}
    volumes:
      - {{ build_dir }}/out/{{ crs.name }}/{{ project }}:/out
      - {{ volume_name('keys_data', crs.name) }}:/keys:ro
{%- if crs.host_docker_builder %}
      - /var/run/docker.sock:/var/run/docker.sock
{%- endif %}
{%- if harness_source %}
      - {{ harness_source }}:/harness-source:ro
{%- endif %}
{%- if diff_path %}
      - {{ diff_path }}:/ref.diff:ro
{%- endif %}
{%- for vol in crs.volumes %}
      - {{ vol }}
{%- endfor %}
    cpuset: {{ crs.cpuset }}
    deploy:
      resources:
        limits:
          memory: {{ crs.memory_limit }}
    command: {{ fuzzer_command | tojson }}
{%- endif %}
{%- endfor %}

{%- if not external_litellm %}
networks:
  {{ config_hash }}_crs_network:
    external: true
    name: {{ config_hash }}_crs_network

{%- endif %}
volumes:
{%- for crs in crs_list %}
  {{ volume_name('keys_data', crs.name) }}:
    name: {{ volume_name('keys_data', crs.name) }}
{%- endfor %}
