{# Environment variables are merged from:
   - crs_registry/<crs>/config-crs.yaml (run_env/build_env)
   - example_configs/<config>/.env
   .env values override config-crs.yaml on conflict.
#}

{# Macro to generate LITELLM_URL environment variable #}
{%- macro litellm_url_env() %}
{%- if external_litellm %}
      - LITELLM_URL=${LITELLM_URL}
{%- else %}
      - LITELLM_URL=http://crs-litellm-{{ config_hash }}-litellm-1:4000
{%- endif %}
{%- endmacro %}

{# Macro to generate CRS network configuration #}
{%- macro crs_network() %}
{%- if not external_litellm %}
    networks:
      - {{ config_hash }}_crs_network
{%- endif %}
{%- endmacro %}

{# Macro to generate volume name #}
{%- macro volume_name(volume_type, crs_name) -%}
{{ config_hash }}_{{ volume_type }}_{{ crs_name }}
{%- endmacro %}

services:
{%- for crs in crs_list %}

{%- if mode == 'build' %}
  # CRS Builder {{ loop.index }} - {{ crs.name }}
  {{ crs.name }}_builder:
    profiles:
      - {{ crs.name }}_builder
    image: {{ project }}_{{ crs.name }}_builder
{%- if crs.dind and not crs.host_docker_builder %}
    privileged: true
{%- endif %}
    shm_size: 2g
    environment:
{%- if crs.dind %}
      - PARENT_IMAGE={{ parent_image_prefix }}/{{ project }}
      - SOURCE_WORKDIR={{ source_workdir }}
{%- endif %}
      - FUZZING_ENGINE={{ engine }}
      - SANITIZER={{ sanitizer }}
      - ARCHITECTURE={{ architecture }}
      - PROJECT_NAME={{ project }}
      - FUZZING_LANGUAGE={{ project_language }}
      - HELPER=True
{%- for key, value in crs.build_env.items() %}
      - {{ key }}={{ value }}
{%- endfor %}
      - CPUSET_CPUS={{ crs.cpuset }}
      - MEMORY_LIMIT={{ crs.memory_limit | string }}
{%- if crs.host_docker_builder %}
      - HOST_WORK_DIR={{ build_dir }}/work/{{ crs.name }}/{{ project }}
      - HOST_OUT_DIR={{ build_dir }}/out/{{ crs.name }}/{{ project }}
      - HOST_ARTIFACT_DIR={{ build_dir }}/artifacts/{{ crs.name }}/{{ project }}
      - HOST_CRS_DIR={{ crs.path }}
{%- endif %}
    build:
      context: {{ crs.path }}
      dockerfile: builder.Dockerfile
      additional_contexts:
        project: {{ oss_fuzz_path }}/projects/{{ project }}
      args:
        - CRS_TARGET={{ project }}
        - PROJECT_PATH={{ oss_fuzz_path }}/projects/{{ project }}
        - parent_image={{ parent_image_prefix }}/{{ project }}
    volumes:
      - {{ build_dir }}/out/{{ crs.name }}/{{ project }}:/out
      - {{ build_dir }}/work/{{ crs.name }}/{{ project }}:/work
      - {{ build_dir }}/artifacts/{{ crs.name }}/{{ project }}:/artifacts
{%- if crs.dind %}
      - {{ build_dir }}/crs/parent-images/{{ project }}.tar:/project-image.tar:ro
{%- endif %}
{%- if crs.dind and not crs.host_docker_builder %}
      - {{ build_dir }}/docker-data/{{ crs.name }}/{{ project }}:/var/lib/docker
{%- endif %}
{%- if crs.host_docker_builder %}
      - /var/run/docker.sock:/var/run/docker.sock
      # Same-path mounts for host docker socket mode - paths match on host and container
      - {{ build_dir }}/out/{{ crs.name }}/{{ project }}:{{ build_dir }}/out/{{ crs.name }}/{{ project }}
      - {{ build_dir }}/work/{{ crs.name }}/{{ project }}:{{ build_dir }}/work/{{ crs.name }}/{{ project }}
      - {{ build_dir }}/artifacts/{{ crs.name }}/{{ project }}:{{ build_dir }}/artifacts/{{ crs.name }}/{{ project }}
{%- endif %}
{%- for vol in crs.volumes %}
      - {{ vol }}
{%- endfor %}
{%- if source_path %}
      - {{ source_path }}:/local-source-mount
{%- endif %}
{%- if crs.cpuset %}
    cpuset: {{ crs.cpuset }}
{%- endif %}
{%- if crs.memory_limit %}
    deploy:
      resources:
        limits:
          memory: {{ crs.memory_limit }}
{%- endif %}
{%- endif %}

{%- if mode == 'run' %}
{%- if not external_litellm %}
  # Key Provisioner {{ loop.index }} - {{ crs.name }} (internal LiteLLM only)
  {{ crs.name }}_key_provisioner:
    build:
      context: {{ key_provisioner_path }}
      dockerfile: Dockerfile
    environment:
{{ litellm_url_env() }}
      - LITELLM_MASTER_KEY=${LITELLM_MASTER_KEY}
{{ crs_network() }}
    volumes:
      - {{ volume_name('keys_data', crs.name) }}:/keys/{{ crs.name }}
      - {{ config_dir }}:/config:ro
    command: ["python", "key_provisioner.py", "--config-dir", "/config", "--crs", "{{ crs.name }}"]
    healthcheck:
      test: ["CMD", "test", "-f", "/keys/{{ crs.name }}/api_key"]
      interval: 2s
      timeout: 1s
      retries: 30
{%- endif %}

  # CRS Runner {{ loop.index }} - {{ crs.name }}
  {{ crs.name }}_runner:
    image: {{ crs.name }}_runner
{%- if not crs.host_docker_builder %}
    privileged: true
{%- endif %}
    shm_size: 2g
{%- if not external_litellm %}
    depends_on:
      {{ crs.name }}_key_provisioner:
        condition: service_healthy
{%- endif %}
    environment:
{{ litellm_url_env() }}
{%- if external_litellm %}
      - LITELLM_KEY=${LITELLM_KEY}
{%- endif %}
      - FUZZING_ENGINE={{ engine }}
      - SANITIZER={{ sanitizer }}
      - RUN_FUZZER_MODE=interactive
      - HELPER=True
      - CPUSET_CPUS={{ crs.cpuset }}
      - MEMORY_LIMIT={{ crs.memory_limit | string }}
      - CRS_TARGET={{ project }}
      - CRS_NAME={{ crs.name }}
{%- for key, value in crs.run_env.items() %}
      - {{ key }}={{ value }}
{%- endfor %}
{%- if crs.host_docker_builder %}
      - HOST_OUT_DIR={{ build_dir }}/out/{{ crs.name }}/{{ project }}
      - HOST_ARTIFACT_DIR={{ build_dir }}/artifacts/{{ crs.name }}/{{ project }}
{%- if harness_name %}
      # Per-harness HOST paths for nested containers (host_docker_builder mode)
      - HOST_POV_DIR={{ build_dir }}/artifacts/{{ crs.name }}/{{ project }}/run/{{ harness_name }}/povs
      - HOST_CORPUS_DIR={{ build_dir }}/artifacts/{{ crs.name }}/{{ project }}/run/{{ harness_name }}/corpus
      - HOST_CRS_DATA_DIR={{ build_dir }}/artifacts/{{ crs.name }}/{{ project }}/run/{{ harness_name }}/crs-data
{%- endif %}
{%- if not external_litellm %}
      - CRS_EXTERNAL_NETWORK={{ config_hash }}_crs_network
{%- endif %}
{%- endif %}
{{ crs_network() }}
    build:
      context: {{ crs.path }}
      dockerfile: runner.Dockerfile
      args:
        - PROJECT_PATH={{ oss_fuzz_path }}/projects/{{ project }}
    volumes:
      - {{ build_dir }}/out/{{ crs.name }}/{{ project }}:/out
{%- if coverage_build_dir %}
      - {{ coverage_build_dir }}:/coverage-out:ro
{%- endif %}
      - {{ build_dir }}/artifacts/{{ crs.name }}/{{ project }}:/artifacts
{%- if harness_name %}
      # Per-harness artifact overlays (povs, corpus, crs-data are per-harness)
      - {{ build_dir }}/artifacts/{{ crs.name }}/{{ project }}/run/{{ harness_name }}/povs:/artifacts/povs
      - {{ build_dir }}/artifacts/{{ crs.name }}/{{ project }}/run/{{ harness_name }}/corpus:/artifacts/corpus
      - {{ build_dir }}/artifacts/{{ crs.name }}/{{ project }}/run/{{ harness_name }}/crs-data:/artifacts/crs-data
{%- endif %}
{%- if not external_litellm %}
      - {{ volume_name('keys_data', crs.name) }}:/keys:ro
{%- endif %}
{%- if crs.host_docker_builder %}
      - /var/run/docker.sock:/var/run/docker.sock
{%- endif %}
{%- if crs.dind and not crs.host_docker_builder %}
      - {{ build_dir }}/docker-data/{{ crs.name }}/{{ project }}:/var/lib/docker
{%- endif %}
{%- if harness_source %}
      - {{ harness_source }}:/harness-source:ro
{%- endif %}
{%- if diff_path %}
      - {{ diff_path }}:/ref.diff:ro
{%- endif %}
{%- for vol in crs.volumes %}
      - {{ vol }}
{%- endfor %}
{%- if ensemble_dir %}
      # Ensemble shared corpus - read-only mount populated by seed_watcher service
      - {{ ensemble_dir }}/corpus:/seed_share_dir:ro
{%- endif %}
    cpuset: {{ crs.cpuset }}
    deploy:
      resources:
        limits:
          memory: {{ crs.memory_limit }}
    command: {{ fuzzer_command | tojson }}
{%- endif %}
{%- endfor %}

{%- if mode == 'run' and ensemble_dir and harness_name %}
  # Ensemble Watcher - monitors corpus and povs directories, deduplicates by content hash
  ensemble_watcher:
    build:
      context: {{ seed_watcher_path }}
      dockerfile: Dockerfile
    volumes:
      # Ensemble shared directories - writable for the watcher
      - {{ ensemble_dir }}/corpus:/ensemble/corpus:rw
      - {{ ensemble_dir }}/povs:/ensemble/povs:rw
      # Mount each CRS corpus directory as read-only
{%- for crs in crs_list %}
      - {{ build_dir }}/artifacts/{{ crs.name }}/{{ project }}/run/{{ harness_name }}/corpus:/watch/corpus/{{ crs.name }}:ro
{%- endfor %}
      # Mount each CRS povs directory as read-only
{%- for crs in crs_list %}
      - {{ build_dir }}/artifacts/{{ crs.name }}/{{ project }}/run/{{ harness_name }}/povs:/watch/povs/{{ crs.name }}:ro
{%- endfor %}
    command:
      - python3
      - seed_watcher.py
      - --corpus-dirs
      - "{% for crs in crs_list %}/watch/corpus/{{ crs.name }}{% if not loop.last %},{% endif %}{% endfor %}"
      - --shared-corpus-dir
      - /ensemble/corpus
      - --povs-dirs
      - "{% for crs in crs_list %}/watch/povs/{{ crs.name }}{% if not loop.last %},{% endif %}{% endfor %}"
      - --shared-povs-dir
      - /ensemble/povs
{%- endif %}

{%- if not external_litellm %}
networks:
  {{ config_hash }}_crs_network:
    external: true
    name: {{ config_hash }}_crs_network

{%- endif %}
{%- if not external_litellm %}
volumes:
{%- for crs in crs_list %}
  {{ volume_name('keys_data', crs.name) }}:
    name: {{ volume_name('keys_data', crs.name) }}
{%- endfor %}
{%- endif %}
