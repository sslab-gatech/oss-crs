{# Environment variables are merged from:
   - crs_registry/<crs>/config-crs.yaml (run_env/build_env)
   - example_configs/<config>/.env
   .env values override config-crs.yaml on conflict.
#}

{# Macro to generate LITELLM_URL environment variable #}
{%- macro litellm_url_env() %}
{%- if external_litellm %}
      - LITELLM_URL=${LITELLM_URL}
{%- else %}
      - LITELLM_URL=http://litellm:4000
{%- endif %}
{%- endmacro %}


services:
{%- if mode == 'run' and not external_litellm %}
  # PostgreSQL database for LiteLLM (ephemeral - no volume mount)
  postgres:
    image: postgres:16-alpine
    attach: false
    environment:
      - POSTGRES_USER=crs
      - POSTGRES_PASSWORD={{ postgres_password }}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U crs -h localhost -p 5432"]
      interval: 5s
      timeout: 5s
      retries: 5

  # LiteLLM proxy server
  litellm:
    image: ghcr.io/berriai/litellm-database:main-stable
    attach: false
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      - LITELLM_MASTER_KEY={{ litellm_master_key }}
      - DATABASE_URL=postgresql://crs:{{ postgres_password }}@postgres:5432/crs
{%- for env_var in litellm_env_vars %}
      - {{ env_var }}=${{"{"}}{{ env_var }}{{"}"}}
{%- endfor %}
    volumes:
      - {{ litellm_config_path }}:/app/config.yaml:ro
    healthcheck:
      test: ["CMD-SHELL", "test -f /tmp/healthy || (python -c \"import urllib.request; urllib.request.urlopen(urllib.request.Request('http://localhost:4000/health', headers={'Authorization': 'Bearer {{ litellm_master_key }}'}))\" && touch /tmp/healthy)"]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 30s
    command: --config /app/config.yaml
{%- endif %}

{%- if mode == 'run' and not external_litellm %}
  # Key Provisioner - registers budgeted keys for all CRS instances
  key_provisioner:
    image: crs-key-provisioner:latest
    build:
      context: {{ key_provisioner_path }}
      dockerfile: Dockerfile
    depends_on:
      litellm:
        condition: service_healthy
    environment:
{{ litellm_url_env() }}
      - LITELLM_MASTER_KEY={{ litellm_master_key }}
{%- for crs in crs_list %}
      - LITELLM_KEY_{{ crs.name }}={{ litellm_keys[crs.name] }}
{%- endfor %}
    volumes:
      - {{ config_dir }}:/config:ro
    command: ["python", "key_provisioner.py", "--config-dir", "/config"]
    healthcheck:
      test: ["CMD", "test", "-f", "/tmp/key_provisioned"]
      interval: 2s
      timeout: 1s
      retries: 30
{%- endif %}

{%- for crs in crs_list %}

{%- if mode == 'build' %}
  # CRS Builder {{ loop.index }} - {{ crs.name }}
  {{ crs.name }}_builder:
    image: {{ project }}_{{ crs.name }}_builder
{%- if crs.dind and not crs.host_docker_builder %}
    privileged: true
{%- endif %}
    shm_size: 2g
    environment:
      - SOURCE_WORKDIR={{ source_workdir }}
{%- if crs.dind %}
      - PARENT_IMAGE={{ parent_image_prefix }}/{{ project }}
{%- endif %}
      - FUZZING_ENGINE={{ engine }}
      - SANITIZER={{ sanitizer }}
      - ARCHITECTURE={{ architecture }}
      - PROJECT_NAME={{ project }}
      - FUZZING_LANGUAGE={{ project_language }}
      - HELPER=True
{%- for key, value in crs.build_env.items() %}
      - {{ key }}={{ value }}
{%- endfor %}
      - CPUSET_CPUS={{ crs.cpuset }}
      - MEMORY_LIMIT={{ crs.memory_limit | string }}
{%- if cgroup_parent %}
      - CGROUP_PARENT={{ cgroup_parent }}/{{ crs.name }}
{%- endif %}
      - RUN_ID={{ run_id }}
{%- if crs.host_docker_builder %}
      - HOST_WORK_DIR={{ build_dir }}/work/{{ crs.name }}/{{ project }}/{{ sanitizer }}
      - HOST_OUT_DIR={{ build_dir }}/out/{{ crs.name }}/{{ project }}/{{ sanitizer }}
      - HOST_ARTIFACT_DIR={{ build_dir }}/artifacts/{{ crs.name }}/{{ project }}/{{ sanitizer }}
      - HOST_CRS_DIR={{ crs.path }}
{%- endif %}
    build:
      context: {{ crs.path }}
      dockerfile: builder.Dockerfile
      additional_contexts:
        project: {{ oss_fuzz_path }}/projects/{{ project }}
      args:
        - CRS_TARGET={{ project }}
        - PROJECT_PATH={{ oss_fuzz_path }}/projects/{{ project }}
        - parent_image={{ parent_image_prefix }}/{{ project }}
    volumes:
      - {{ build_dir }}/out/{{ crs.name }}/{{ project }}/{{ sanitizer }}:/out
      - {{ build_dir }}/work/{{ crs.name }}/{{ project }}/{{ sanitizer }}:/work
      - {{ build_dir }}/artifacts/{{ crs.name }}/{{ project }}/{{ sanitizer }}:/artifacts
{%- if crs.dind and not crs.host_docker_builder %}
      - {{ build_dir }}/docker-data/{{ crs.name }}/build/{{ project }}/{{ sanitizer }}:/var/lib/docker
{%- endif %}
{%- if crs.host_docker_builder %}
      - /var/run/docker.sock:/var/run/docker.sock
      # Same-path mounts for host docker socket mode - paths match on host and container
      - {{ build_dir }}/out/{{ crs.name }}/{{ project }}/{{ sanitizer }}:{{ build_dir }}/out/{{ crs.name }}/{{ project }}/{{ sanitizer }}
      - {{ build_dir }}/work/{{ crs.name }}/{{ project }}/{{ sanitizer }}:{{ build_dir }}/work/{{ crs.name }}/{{ project }}/{{ sanitizer }}
      - {{ build_dir }}/artifacts/{{ crs.name }}/{{ project }}/{{ sanitizer }}:{{ build_dir }}/artifacts/{{ crs.name }}/{{ project }}/{{ sanitizer }}
{%- endif %}
{%- for vol in crs.volumes %}
      - {{ vol }}
{%- endfor %}
{%- if source_path %}
      - {{ source_path }}:/local-source-mount
{%- endif %}
{%- if cgroup_parent %}
    cgroup_parent: {{ cgroup_parent }}/{{ crs.name }}
{%- else %}
{%- if crs.cpuset %}
    cpuset: {{ crs.cpuset }}
{%- endif %}
{%- if crs.memory_limit %}
    deploy:
      resources:
        limits:
          memory: {{ crs.memory_limit }}
{%- endif %}
{%- endif %}
{%- endif %}

{%- if mode == 'run' %}
  # CRS Runner {{ loop.index }} - {{ crs.name }}
  {{ crs.name }}_runner:
    image: {{ crs.name }}_runner
{%- if not crs.host_docker_builder %}
    privileged: true
{%- endif %}
    shm_size: 2g
{%- if not external_litellm %}
    depends_on:
      key_provisioner:
        condition: service_healthy
{%- endif %}
    environment:
{{ litellm_url_env() }}
{%- if external_litellm %}
      - LITELLM_KEY=${LITELLM_KEY}
{%- else %}
      - LITELLM_KEY={{ litellm_keys[crs.name] }}
{%- endif %}
      - FUZZING_ENGINE={{ engine }}
      - SANITIZER={{ sanitizer }}
      - RUN_FUZZER_MODE=interactive
      - HELPER=True
      - CPUSET_CPUS={{ crs.cpuset }}
      - MEMORY_LIMIT={{ crs.memory_limit | string }}
{%- if cgroup_parent %}
      - CGROUP_PARENT={{ cgroup_parent }}/{{ crs.name }}
{%- endif %}
      - RUN_ID={{ run_id }}
      - CRS_TARGET={{ project }}
      - CRS_NAME={{ crs.name }}
      - SOURCE_WORKDIR={{ source_workdir }}
{%- for key, value in crs.run_env.items() %}
      - {{ key }}={{ value }}
{%- endfor %}
{%- if crs.host_docker_builder %}
      - HOST_OUT_DIR={{ build_dir }}/out/{{ crs.name }}/{{ project }}/{{ sanitizer }}
      - HOST_ARTIFACT_DIR={{ build_dir }}/artifacts/{{ crs.name }}/{{ project }}/{{ sanitizer }}
{%- if harness_name %}
      # Per-harness HOST paths for nested containers (host_docker_builder mode)
      - HOST_POV_DIR={{ build_dir }}/run/{{ crs.name }}/{{ project }}/{{ sanitizer }}/{{ harness_name }}/{{ run_id }}/povs
      - HOST_CORPUS_DIR={{ build_dir }}/run/{{ crs.name }}/{{ project }}/{{ sanitizer }}/{{ harness_name }}/{{ run_id }}/corpus
      - HOST_CRS_DATA_DIR={{ build_dir }}/run/{{ crs.name }}/{{ project }}/{{ sanitizer }}/{{ harness_name }}/{{ run_id }}/crs-data
{%- endif %}
{%- endif %}
    build:
      context: {{ crs.path }}
      dockerfile: runner.Dockerfile
    volumes:
      - {{ build_dir }}/out/{{ crs.name }}/{{ project }}/{{ sanitizer }}:/out
{%- if coverage_build_dir %}
      - {{ coverage_build_dir }}:/coverage-out:ro
{%- endif %}
      - {{ build_dir }}/artifacts/{{ crs.name }}/{{ project }}/{{ sanitizer }}:/artifacts
{%- if harness_name %}
      # Per-run writable overlays (povs, corpus, crs-data isolated per run)
      - {{ build_dir }}/run/{{ crs.name }}/{{ project }}/{{ sanitizer }}/{{ harness_name }}/{{ run_id }}/povs:/artifacts/povs
      - {{ build_dir }}/run/{{ crs.name }}/{{ project }}/{{ sanitizer }}/{{ harness_name }}/{{ run_id }}/corpus:/artifacts/corpus
      - {{ build_dir }}/run/{{ crs.name }}/{{ project }}/{{ sanitizer }}/{{ harness_name }}/{{ run_id }}/crs-data:/artifacts/crs-data
{%- endif %}
{%- if crs.host_docker_builder %}
      - /var/run/docker.sock:/var/run/docker.sock
{%- endif %}
{%- if crs.dind and not crs.host_docker_builder %}
      - {{ build_dir }}/docker-data/{{ crs.name }}/run/{{ project }}/{{ sanitizer }}:/var/lib/docker
{%- endif %}
{%- if harness_source %}
      - {{ harness_source }}:/harness-source:ro
{%- endif %}
{%- if diff_path %}
      - {{ diff_path }}:/ref.diff:ro
{%- endif %}
{%- for vol in crs.volumes %}
      - {{ vol }}
{%- endfor %}
{%- if ensemble_dir %}
      # Ensemble shared corpus - read-only mount populated by seed_watcher service
      - {{ ensemble_dir }}/corpus:/seed_share_dir:ro
{%- endif %}
{%- if cgroup_parent %}
    cgroup_parent: {{ cgroup_parent }}/{{ crs.name }}
{%- else %}
    cpuset: {{ crs.cpuset }}
    deploy:
      resources:
        limits:
          memory: {{ crs.memory_limit }}
{%- endif %}
    command: {{ fuzzer_command | tojson }}
{%- endif %}
{%- endfor %}

{%- if mode == 'run' and ensemble_dir and harness_name %}
  # Ensemble Watcher - monitors corpus and povs directories, deduplicates by content hash
  ensemble_watcher:
    image: crs-ensemble-watcher:latest
    build:
      context: {{ seed_watcher_path }}
      dockerfile: Dockerfile
    volumes:
      # Ensemble shared directories - writable for the watcher
      - {{ ensemble_dir }}/corpus:/ensemble/corpus:rw
      - {{ ensemble_dir }}/povs:/ensemble/povs:rw
      # Mount each CRS corpus directory as read-only
{%- for crs in crs_list %}
      - {{ build_dir }}/run/{{ crs.name }}/{{ project }}/{{ sanitizer }}/{{ harness_name }}/{{ run_id }}/corpus:/watch/corpus/{{ crs.name }}:ro
{%- endfor %}
      # Mount each CRS povs directory as read-only
{%- for crs in crs_list %}
      - {{ build_dir }}/run/{{ crs.name }}/{{ project }}/{{ sanitizer }}/{{ harness_name }}/{{ run_id }}/povs:/watch/povs/{{ crs.name }}:ro
{%- endfor %}
    command:
      - python3
      - seed_watcher.py
      - --corpus-dirs
      - "{% for crs in crs_list %}/watch/corpus/{{ crs.name }}{% if not loop.last %},{% endif %}{% endfor %}"
      - --shared-corpus-dir
      - /ensemble/corpus
      - --povs-dirs
      - "{% for crs in crs_list %}/watch/povs/{{ crs.name }}{% if not loop.last %},{% endif %}{% endfor %}"
      - --shared-povs-dir
      - /ensemble/povs
{%- endif %}

