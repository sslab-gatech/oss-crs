services:
{%- for crs in crs_list %}

{%- if mode == 'build' %}
  # Key Provisioner {{ loop.index }} - {{ crs.name }}
  {{ crs.name }}_key_provisioner:
    profiles:
      - {{ crs.name }}_builder
    build:
      context: {{ key_provisioner_path }}
      dockerfile: Dockerfile
    environment:
{%- if external_litellm %}
      - LITELLM_URL=${LITELLM_URL}
      - LITELLM_KEY=${LITELLM_KEY}
      - EXTERNAL_LITELLM=true
{%- else %}
      - LITELLM_URL=http://crs-litellm-{{ config_hash }}-litellm-1:4000
      - LITELLM_MASTER_KEY=${LITELLM_MASTER_KEY}
{%- endif %}
{%- if not external_litellm %}
    networks:
      - {{ config_hash }}_crs_network
{%- endif %}
    volumes:
      - {{ config_hash }}_keys_data_{{ crs.name }}:/keys/{{ crs.name }}
      - {{ config_dir }}:/config:ro
    command: ["python", "key_provisioner.py", "--config-dir", "/config", "--crs", "{{ crs.name }}"]
    # restart: on-failure:5

  # CRS Builder {{ loop.index }} - {{ crs.name }}
  {{ crs.name }}_builder:
    profiles:
      - {{ crs.name }}_builder
    image: {{ project }}_{{ crs.name }}_builder{% if source_tag %}:{{ source_tag }}{% endif %}
    depends_on:
      {{ crs.name }}_key_provisioner:
        condition: service_started
    environment:
{%- if external_litellm %}
      - LITELLM_URL=${LITELLM_URL}
{%- else %}
      - LITELLM_URL=http://crs-litellm-{{ config_hash }}-litellm-1:4000
{%- endif %}
      - FUZZING_ENGINE={{ engine }}
      - SANITIZER={{ sanitizer }}
      - ARCHITECTURE={{ architecture }}
      - PROJECT_NAME={{ project }}
      - FUZZING_LANGUAGE={{ project_language }}
      - HELPER=True
{%- if not external_litellm %}
    networks:
      - {{ config_hash }}_crs_network
{%- endif %}
    build:
      context: {{ crs.path }}
      dockerfile: builder.Dockerfile
      additional_contexts:
        project: {{ oss_fuzz_path }}/projects/{{ project }}
      args:
        - CRS_TARGET={{ project }}
        - PROJECT_PATH={{ oss_fuzz_path }}/projects/{{ project }}
        - parent_image=gcr.io/oss-fuzz/{{ project }}
    volumes:
      - {{ build_dir }}/out/{{ crs.name }}/{{ project }}:/out
      - {{ build_dir }}/work/{{ crs.name }}/{{ project }}:/work
      - {{ config_hash }}_keys_data_{{ crs.name }}:/keys:ro
{%- if source_path %}
      - {{ source_path }}:/local-source-mount
{%- endif %}
{%- endif %}

{%- if mode == 'run' %}
  # CRS Runner {{ loop.index }} - {{ crs.name }}
  {{ crs.name }}_runner:
    image: {{ crs.name }}_runner
    privileged: true
    environment:
{%- if external_litellm %}
      - LITELLM_URL=${LITELLM_URL}
{%- else %}
      - LITELLM_URL=http://crs-litellm-{{ config_hash }}-litellm-1:4000
{%- endif %}
      - FUZZING_ENGINE={{ engine }}
      - SANITIZER={{ sanitizer }}
      - RUN_FUZZER_MODE=interactive
      - HELPER=True
      - CPUSET_CPUS={{ crs.cpuset }}
      - MEMORY_LIMIT={{ crs.memory_limit | string }}
      - CRS_TARGET={{ project }}
{%- if not external_litellm %}
    networks:
      - {{ config_hash }}_crs_network
{%- endif %}
    build:
      context: {{ crs.path }}
      dockerfile: runner.Dockerfile
      args:
        - PROJECT_PATH={{ oss_fuzz_path }}/projects/{{ project }}
    volumes:
      - {{ build_dir }}/out/{{ crs.name }}/{{ project }}:/out
      - {{ config_hash }}_keys_data_{{ crs.name }}:/keys:ro
{%- if harness_source %}
      - {{ harness_source }}:/harness-source:ro
{%- endif %}
    cpuset: {{ crs.cpuset }}
    deploy:
      resources:
        limits:
          memory: {{ crs.memory_limit }}
    command: {{ fuzzer_command | tojson }}
{%- endif %}
{%- endfor %}

{%- if not external_litellm %}
networks:
  {{ config_hash }}_crs_network:
    external: true
    name: {{ config_hash }}_crs_network

{%- endif %}
volumes:
{%- for crs in crs_list %}
  {{ config_hash }}_keys_data_{{ crs.name }}:
    name: {{ config_hash }}_keys_data_{{ crs.name }}
{%- endfor %}
