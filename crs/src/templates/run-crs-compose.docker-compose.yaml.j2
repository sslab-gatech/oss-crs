networks:
  {{ crs_compose_name }}-network:
    driver: bridge
    name: {{ crs_compose_name }}-network
  {{ crs_compose_name }}-infra-only-network:
    driver: bridge
    name: {{ crs_compose_name }}-infra-only-network
  {%- for crs in crs_list %}
  {{ crs_compose_name }}-{{ crs.name }}-network:
    driver: bridge
    name: {{ crs_compose_name}}-{{ crs.name }}-network
  {%- endfor %}

volumes:
  crs-shared-volume:
    driver: local
    name: {{ crs_compose_name }}-shared-volume

services:
# crs.name can be different from name defined in crs.yaml; crs.name comes from crs-compose.yaml
{% for crs in crs_list %} 
{% for module_name, module_config in crs.config.crs_run_phase.modules.items() %}
  {{ crs.name }}_{{ module_name }}:
    privileged: true
    build:
      context: {{ crs.crs_path }}
      dockerfile: {{ crs.crs_path }}/{{ module_config.dockerfile }}
      additional_contexts:
        libcrs: {{ libCRS_path }}
      args:
        - target_base_image={{target.get_docker_image_name()}}
        - crs_version={{ crs.version }}
    environment:
      ###########################################
      # OSS_FUZZ standard environment variables
      ###########################################
      - HELPER=True
      - RUN_FUZZER_MODE=interactive
      - FUZZING_ENGINE={{ target_env.engine }}
      - SANITIZER={{ target_env.sanitizer }}
      - ARCHITECTURE={{ target_env.architecture }}
      - PROJECT_NAME={{ target_env.name }}
      - FUZZING_LANGUAGE={{ target_env.language }}
      ###########################################
      # OSS_CRS specific environment variables
      ###########################################
      - OSS_CRS_RUN_ENV_TYPE={{ crs_compose_env.type }}
      - OSS_CRS_NAME={{ crs.name }}
      - OSS_CRS_SERVICE_NAME={{ crs.name }}_{{ module_name }}
      - OSS_CRS_TARGET={{ target_env.name }}
      - OSS_CRS_TARGET_HARNESS={{ target_env.harness }}
      - OSS_CRS_CPUSET="{{ crs.resource.cpuset }}"
      - OSS_CRS_MEMORY_LIMIT="{{ crs.resource.memory }}"
      - OSS_CRS_BUILD_OUT_DIR=/OSS_CRS_BUILD_OUT_DIR
      - OSS_CRS_SUBMIT_DIR=/OSS_CRS_SUBMIT_DIR
      - OSS_CRS_FETCH_DIR=/OSS_CRS_FETCH_DIR
      - OSS_CRS_SHARED_DIR=/OSS_CRS_SHARED_DIR
      ###########################################
{%- for env_key, env_value in module_config.additional_env.items() %}
      - {{ env_key }}={{ env_value }}
{%- endfor %}
{%- if llm_context is defined %}
      - OSS_CRS_LLM_API_URL=http://litellm.oss-crs:4000
      - OSS_CRS_LLM_API_KEY={{ llm_context.api_keys[crs.name] }}
    depends_on:
      oss-crs-litellm-key-gen:
        condition: service_completed_successfully
{%- endif %}
    cpuset: "{{ crs.resource.cpuset }}"
    # TODO: Check memory limit because it's for all services in a single CRS
    mem_limit: "{{ crs.resource.memory }}"
    volumes:
      - {{ crs.get_build_output_dir(target) }}:/OSS_CRS_BUILD_OUT_DIR:ro
      - {{ crs.get_submit_dir(target) }}:/OSS_CRS_SUBMIT_DIR:rw
      - {{ crs.get_fetch_dir(target) }}:/OSS_CRS_FETCH_DIR:ro
      - {{ crs.get_shared_dir(target) }}:/OSS_CRS_SHARED_DIR:rw
    networks:
      {{ crs_compose_name }}-{{ crs.name }}-network:
        aliases:
          - {{module_name}}.{{ crs.name }}
      {{ crs_compose_name }}-network:
{% endfor %}
{% endfor %}
  ###########################################
  # OSS-CRS-INFRA-SERVICES
  # - oss-crs-litellm
  # - oss-crs-postgres
{% if llm_context is defined %}
  ###########################################
  # OSS-CRS-LITELLM
  ###########################################
  oss-crs-litellm:
    image: ghcr.io/berriai/litellm-database:main-stable 
    depends_on:
      oss-crs-postgres:
        condition: service_healthy
    environment:
      - LITELLM_MASTER_KEY={{ llm_context.litellm_master_key }}
      - DATABASE_URL=postgresql://crs:{{ llm_context.postgres_password }}@postgres.oss-crs-infra-only:5432/crs
    {%- for key, value in llm_context.litellm_env.items() %}
      - {{ key }}={{ value }}
    {%- endfor %}
    volumes:
      - {{ llm_context.litellm_config_path }}:/app/config.yaml:ro
    networks:
      {{ crs_compose_name }}-infra-only-network:
      {{ crs_compose_name }}-network:
        aliases:
          - litellm.oss-crs
    command: --config /app/config.yaml
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request; urllib.request.urlopen('http://localhost:4000/health/liveliness')\""]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 15s
  oss-crs-postgres:
    image: postgres:16-alpine
    attach: false
    environment:
      - POSTGRES_USER=crs
      - POSTGRES_PASSWORD={{ llm_context.postgres_password }}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U crs -h localhost -p 5432"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      {{ crs_compose_name }}-infra-only-network:
        aliases:
          - postgres.oss-crs-infra-only
  oss-crs-litellm-key-gen:
    image: oss-crs-litellm-key-gen:latest
    build:
      context: {{ oss_crs_infra_root_path }}/litellm-key-gen
      dockerfile: {{ oss_crs_infra_root_path }}/litellm-key-gen/Dockerfile
    depends_on:
      oss-crs-litellm:
        condition: service_healthy
    environment:
      - LITELLM_MASTER_KEY={{ llm_context.litellm_master_key }}
      - LITELLM_API_URL=http://litellm.oss-crs:4000
    networks:
      {{ crs_compose_name }}-network:
    volumes:
      - {{ llm_context.key_gen_request_path }}:/key_gen_request.yaml:ro
  ###########################################
{% endif %}